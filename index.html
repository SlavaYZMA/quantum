<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Квантовые портреты</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
</head>
<body>
    <section id="step-0" class="step step-centered">
        <div class="text-block typewriter" data-i18n="step0_text">Пожалуйста, выберите язык RU / ENG</div>
        <div class="button-block">
            <button class="language-btn" data-lang="ru">RU</button>
            <button class="language-btn" data-lang="eng">ENG</button>
        </div>
    </section>

    <section id="step-1" class="step step-centered">
        <div class="step-title" data-i18n="step1_title">СТАТУС: НАБЛЮДАТЕЛЬ ПОДКЛЮЧЁН</div>
        <div class="text-block typewriter" data-i18n="step1_text1">> Чему Шредингер может научить нас в области цифровой идентификации?</div>
        <div class="text-block typewriter" data-i18n="step1_text2">> Добро пожаловать в экспериментальную зону.</div>
        <div class="text-block typewriter" data-i18n="step1_text3">> Здесь наблюдение = вмешательство.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
    </section>

    <section id="step-2" class="step step-centered">
        <div class="step-title" data-i18n="step2_title">Шаг 1: Сканируйте лицо суперпозиции.</div>
        <div class="text-block typewriter" data-i18n="step2_text1">Вы можете загрузить изображение или выбрать вариант из архива.</div>
        <div class="button-block">
            <button id="uploadImage">Загрузить изображение</button>
            <button id="openGallery">Выбрать из архива</button>
            <button id="activateCamera">Активировать камеру</button>
        </div>
        <div id="portrait-animation-container"></div>
    </section>

    <section id="step-2.1" class="step step-centered">
        <div class="text-block typewriter" data-i18n="step2_text2">> Изображение принято.</div>
        <div class="text-block typewriter" data-i18n="step2_text3">> Запускается волновая функция.</div>
        <div class="text-block typewriter" data-i18n="step2_text4">> Система готова к инициализации.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container"></div>
    </section>

    <section id="step-3" class="step step-centered">
        <div class="step-title" data-i18n="step3_title">Шаг 2: Инициализация</div>
        <div class="text-block typewriter" data-i18n="step3_text1">> Изображение преобразовано в пиксельную сетку.</div>
        <div class="text-block typewriter" data-i18n="step3_text2">> Каждому пикселю назначены параметры (x, y, brightness, color)</div>
        <div class="text-block typewriter" data-i18n="step3_text3">> На их основе построена волновая функция: ψ(x, y, t)</div>
        <div class="text-block typewriter" data-i18n="step3_text4">Уравнение эволюции:</div>
        <div class="text-block typewriter" data-i18n="step3_text5">iℏ ∂ψ/∂t = Ĥψ, где Ĥ = -½∇² + V(x, y)</div>
        <div class="text-block typewriter" data-i18n="step3_text6">> Потенциал V(x, y) формируется из визуальных характеристик изображения.</div>
        <div class="text-block typewriter" data-i18n="step3_text7">> Система переходит в режим временной симуляции.</div>
        <div class="text-block typewriter" data-i18n="step3_text8">> Портрет существует как совокупность возможных состояний.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container"></div>
    </section>

    <section id="step-4" class="step step-centered">
        <div class="step-title" data-i18n="step4_title">Шаг 3: НАЧНИТЕ НАБЛЮДЕНИЕ</div>
        <div class="text-block typewriter" data-i18n="step4_text1">Двигайте курсором по изображению.</div>
        <div class="text-block typewriter" data-i18n="step4_text2">Каждый ваш жест запускает коллапс.</div>
        <div class="text-block typewriter" data-i18n="step4_text3">Система реагирует. Наблюдаемый образ формируется здесь и сейчас.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container"></div>
    </section>

    <section id="step-5" class="step step-centered">
        <div class="step-title" data-i18n="step5_title">Шаг 4: ФИКСАЦИЯ</div>
        <div class="text-block typewriter" data-i18n="step5_text1">> Портрет — это процесс.</div>
        <div class="text-block typewriter" data-i18n="step5_text2">> Но ты можешь зафиксировать один миг.</div>
        <div class="text-block typewriter" data-i18n="step5_text3">> Это будет один из возможных тебя.</div>
        <div class="button-block">
            <button id="recordButton">Записать</button>
            <div id="saveInput" style="display: none;">
                <input type="text" id="portraitName" placeholder="Имя портрета">
                <button id="saveButton">Сохранить</button>
            </div>
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container"></div>
    </section>

    <section id="step-6" class="step step-centered">
        <div class="step-title" data-i18n="step6_title">Шаг 5: РЕАКЦИЯ СИСТЕМЫ</div>
        <div class="text-block typewriter" data-i18n="step6_text1">Это не портрет.</div>
        <div class="text-block typewriter" data-i18n="step6_text2">Это — реакция системы на тебя.</div>
        <div class="text-block typewriter" data-i18n="step6_text3">Ты повлиял на исход.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container"></div>
    </section>

    <section id="step-7" class="step step-centered">
        <div class="step-title" data-i18n="step7_title">Заключение</div>
        <div class="text-block typewriter" data-i18n="step7_text1">Ты — не единственный наблюдатель</div>
        <div class="text-block typewriter" data-i18n="step7_text2">Каждое наблюдение — это акт, формирующий образ.</div>
        <div class="text-block typewriter" data-i18n="step7_text3">Здесь ты — одновременно субъект и объект.</div>
        <div class="button-block">
            <button onclick="window.restart()">Начать заново</button>
            <button onclick="window.openArchive()">Перейти в архив</button>
            <button onclick="window.aboutAuthors()">Об авторах</button>
        </div>
    </section>

    <script>
        let quantumSketch = null;
        window.img = null;
        window.currentStep = 0;
        window.currentQuantumState = 'init';

        window.loadImageOnce = () => {
            if (window.img) {
                console.warn('Image already loaded, skipping new load');
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log('Loading image:', file.name);
                    initializeQuantumSketch();
                    window.quantumSketch.loadImage(URL.createObjectURL(file), (img) => {
                        window.img = img;
                        console.log('Image loaded successfully, size:', img.width, 'x', img.height);
                        if (window.currentStep === 2) {
                            showStep(2.1);
                        }
                    }, (err) => {
                        console.error('Error loading image:', err);
                    });
                }
            };
            input.click();
        };

        window.activateCamera = () => {
            console.log('Camera activation requested');
            alert('Функция активации камеры пока не реализована.');
        };

        window.openGallery = () => {
            console.log('Gallery opened');
            alert('Функция выбора из архива пока не реализована.');
        };

        window.restart = () => {
            console.log('Restarting application');
            window.img = null;
            window.currentQuantumState = 'init';
            showStep(0);
        };

        window.openArchive = () => {
            console.log('Opening archive');
            alert('Функция перехода в архив наблюдений пока не реализована.');
        };

        window.aboutAuthors = () => {
            console.log('Showing about authors');
            alert('Информация об авторах пока не реализована.');
        };

        function initializeQuantumSketch() {
            if (window.quantumSketch) return;
            const container = document.getElementById('portrait-animation-container');
            if (!container) {
                console.error('Container portrait-animation-container not found');
                return;
            }
            window.quantumSketch = new p5((sketch) => {
                window.sketch = sketch;
                let isPaused = false;
                sketch.setup = () => {
                    let canvas = sketch.createCanvas(400, 400).parent('portrait-animation-container');
                    canvas.canvas.getContext('2d').willReadFrequently = true;
                    console.log('Canvas created, size:', sketch.width, 'x', sketch.height);
                    sketch.noLoop();
                };
                sketch.draw = () => {
                    sketch.background(0);
                    if (window.img && (window.currentStep >= 2)) {
                        console.log('Drawing image, currentStep:', window.currentStep, 'img:', window.img);
                        let scale = Math.min(sketch.width / window.img.width, sketch.height / window.img.height);
                        let displayWidth = window.img.width * scale;
                        let displayHeight = window.img.height * scale;
                        let x = (sketch.width - displayWidth) / 2;
                        let y = (sketch.height - displayHeight) / 2;
                        sketch.image(window.img, x, y, displayWidth, displayHeight);
                        if (!isPaused && window.currentQuantumState) {
                            console.log('Quantum state:', window.currentQuantumState);
                            if (window.currentQuantumState === 'superposition') {
                                for (let i = 0; i < 30; i++) {
                                    let x = sketch.random(sketch.width);
                                    let y = sketch.random(sketch.height);
                                    let prob = sketch.noise(x * 0.01, y * 0.01);
                                    if (prob > 0.3) {
                                        sketch.stroke(0, 255 * prob, 100);
                                        sketch.point(x, y);
                                    }
                                }
                            } else if (window.currentQuantumState === 'collapse') {
                                let centerX = sketch.width / 2;
                                let centerY = sketch.height / 2;
                                for (let i = 0; i < 30; i++) {
                                    let angle = sketch.random(sketch.TWO_PI);
                                    let r = sketch.map(sketch.sin(sketch.frameCount * 0.01 + i), -1, 1, 0, 150);
                                    let x = centerX + r * sketch.cos(angle);
                                    let y = centerY + r * sketch.sin(angle);
                                    sketch.stroke(255, 50, 0, 255 - r * 1.5);
                                    sketch.point(x, y);
                                }
                            }
                        }
                    } else {
                        console.log('No image or invalid step for drawing:', window.currentStep, window.img);
                    }
                };
                sketch.mousePressed = () => {
                    if (window.currentStep === 5 && sketch.mouseX >= 0 && sketch.mouseX <= sketch.width && sketch.mouseY >= 0 && sketch.mouseY <= sketch.height) {
                        isPaused = !isPaused;
                        if (isPaused) {
                            console.log('Animation paused at step 5');
                            window.currentQuantumState = 'collapse';
                            sketch.noLoop();
                            document.getElementById('recordButton').style.display = 'none';
                            document.getElementById('saveInput').style.display = 'block';
                        } else {
                            console.log('Animation resumed at step 5');
                            window.currentQuantumState = 'superposition';
                            sketch.loop();
                            document.getElementById('recordButton').style.display = 'inline-block';
                            document.getElementById('saveInput').style.display = 'none';
                        }
                    }
                };
                sketch.startAnimation = () => {
                    if (!window.img) {
                        console.warn('No image available for animation. Please upload an image on Step 2.');
                        return;
                    }
                    console.log('Starting animation, setting initial state to superposition');
                    window.currentQuantumState = 'superposition';
                    isPaused = false;
                    sketch.loop();
                };
            }, 'portrait-animation-container');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const languageButtons = document.querySelectorAll('.language-btn');
            languageButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const lang = button.getAttribute('data-lang');
                    window.setLanguageAndNext(lang);
                });
            });

            const uploadButton = document.getElementById('uploadImage');
            if (uploadButton) {
                uploadButton.addEventListener('click', window.loadImageOnce);
            }
            const galleryButton = document.getElementById('openGallery');
            if (galleryButton) {
                galleryButton.addEventListener('click', window.openGallery);
            }
            const cameraButton = document.getElementById('activateCamera');
            if (cameraButton) {
                cameraButton.addEventListener('click', window.activateCamera);
            }
        });
    </script>
    <script src="js/globals.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/observer.js"></script>
    <script src="js/textSteps.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/main.js"></script>
    <script src="js/particles.js"></script>
</body>
</html>

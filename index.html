<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Quantum Portrait</title>
    <link rel="icon" href="data:;base64,=">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Source+Sans+Pro&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="./js/globals.js"></script>
    <script src="./js/particles.js"></script>
    <script src="./js/observer.js"></script>
    <script src="./js/main.js"></script>
    <script src="./js/audio.js"></script>
    <script src="./js/textSteps.js"></script>
    <script src="./js/utils.js"></script>
    <script src="js/text-flicker.js"></script>
</head>
<body>
    <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
    </div>
    <section id="step-0" class="step">
        <div class="text-block" data-i18n="step0_text">Пожалуйста, выберите язык RU / ENG</div>
        <div class="button-block">
            <button onclick="window.setLanguageAndNext('ru')">RU</button>
            <button onclick="window.setLanguageAndNext('en')">ENG</button>
        </div>
    </section>
    <section id="step-1" class="step step-asymmetric">
        <div class="text-block">
            <h2 data-i18n="step1_title"></h2>
            <p data-i18n="step1_text1"></p>
            <p data-i18n="step1_text2"></p>
            <p data-i18n="step1_text3"></p>
        </div>
        <div class="button-block">
            <button class="continue" data-i18n="continue">Продолжить</button>
            <button class="back" data-i18n="back">Назад</button>
        </div>
    </section>
    <section id="step-2" class="step step-asymmetric">
        <div class="text-block">
            <h2 data-i18n="step2_title"></h2>
            <p data-i18n="step2_text1"></p>
        </div>
        <div class="button-block">
            <button id="uploadImage" data-i18n="upload_image">Загрузить изображение</button>
            <button id="useCamera" data-i18n="use_camera">Включить камеру</button>
            <button id="useArchive" data-i18n="use_archive">Выбрать из архива</button>
            <button class="back" data-i18n="back">Назад</button>
        </div>
    </section>
    <section id="step-2.1" class="step step-asymmetric">
        <div class="text-block">
            <p data-i18n="step2_text2"></p>
            <p data-i18n="step2_text3"></p>
            <p data-i18n="step2_text4"></p>
        </div>
        <div class="button-block">
            <button class="continue" data-i18n="continue">Продолжить</button>
            <button class="back" data-i18n="back">Назад</button>
        </div>
    </section>
    <section id="step-3" class="step step-asymmetric">
        <div class="text-block">
            <h2 data-i18n="step3_title"></h2>
            <p data-i18n="step3_text1"></p>
            <p data-i18n="step3_text2"></p>
            <p data-i18n="step3_text3"></p>
            <p data-i18n="step3_text4"></p>
            <p data-i18n="step3_text5"></p>
            <p data-i18n="step3_text6"></p>
            <p data-i18n="step3_text7"></p>
            <p data-i18n="step3_text8"></p>
        </div>
        <div class="button-block">
            <button class="continue" data-i18n="continue">Продолжить</button>
            <button class="back" data-i18n="back">Назад</button>
        </div>
    </section>
    <section id="step-4" class="step step-asymmetric">
        <div class="text-block">
            <h2 data-i18n="step4_title"></h2>
            <p data-i18n="step4_text1"></p>
            <p data-i18n="step4_text2"></p>
            <p data-i18n="step4_text3"></p>
        </div>
        <div class="content-grid">
            <img id="thumbnail-portrait" class="thumbnail-portrait" alt="Миниатюра квантового портрета" />
            <div class="portrait-terminal-wrapper">
                <div id="portrait-animation-container-step-4"></div>
                <div class="terminal-log" id="terminal-log-step-4"></div>
            </div>
        </div>
        <div class="button-block">
            <button class="continue" data-i18n="continue">Продолжить</button>
            <button class="back" data-i18n="back">Назад</button>
        </div>
    </section>
    <section id="step-5" class="step step-asymmetric">
        <div class="text-block">
            <h2 data-i18n="step5_title"></h2>
            <p data-i18n="step5_text1"></p>
            <p data-i18n="step5_text2"></p>
            <p data-i18n="step5_text3"></p>
        </div>
        <div class="content-grid">
            <img id="thumbnail-portrait" class="thumbnail-portrait" alt="Миниатюра квантового портрета" />
            <div class="portrait-terminal-wrapper">
                <div id="portrait-animation-container-step-5"></div>
                <div class="terminal-log" id="terminal-log-step-5"></div>
            </div>
        </div>
        <div class="button-block">
            <input id="portraitName" type="text" placeholder="Название портрета" data-i18n-placeholder="portrait_name_placeholder">
            <button id="saveImage" data-i18n="save_observation">[ЗАПИСАТЬ НАБЛЮДЕНИЕ]</button>
            <button class="continue" data-i18n="continue">Продолжить</button>
            <button class="back" data-i18n="back">Назад</button>
        </div>
    </section>
    <section id="step-6" class="step step-asymmetric">
        <div class="text-block">
            <h2 data-i18n="step6_title"></h2>
            <p data-i18n="step6_text1"></p>
            <p data-i18n="step6_text2"></p>
            <p data-i18n="step6_text3"></p>
        </div>
        <div class="button-block">
            <button id="shareObservation" data-i18n="share_observation">[ПОДЕЛИТЬСЯ НАБЛЮДЕНИЕМ]</button>
            <button class="continue" data-i18n="continue">Продолжить</button>
            <button class="back" data-i18n="back">Назад</button>
        </div>
    </section>
    <section id="step-7" class="step step-asymmetric">
        <div class="text-block">
            <p data-i18n="step7_text1"></p>
            <p data-i18n="step7_text2"></p>
            <p data-i18n="step7_text3"></p>
        </div>
        <div class="button-block">
            <button id="restart" data-i18n="restart">[↻ НАЧАТЬ СНАЧАЛА]</button>
            <button id="archive" data-i18n="archive">[⧉ ПЕРЕЙТИ В АРХИВ НАБЛЮДЕНИЙ]</button>
            <button id="aboutAuthors" data-i18n="about_authors">[ОБ АВТОРАХ]</button>
            <button class="back" data-i18n="back">Назад</button>
        </div>
    </section>
    <!-- Модальное окно для выбора изображений из архива -->
    <div id="image-archive-modal" class="modal" style="display: none;" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span id="close-modal" class="close" aria-label="Закрыть модальное окно">×</span>
            <div class="image-grid" id="image-grid"></div>
        </div>
    </div>
    <!-- Модальное окно для камеры -->
    <div id="camera-modal" class="modal" style="display: none;" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span id="close-camera-modal" class="close" aria-label="Закрыть камеру">×</span>
            <video id="camera-video" autoplay style="width: 100%; max-width: 640px; height: auto;"></video>
            <canvas id="camera-canvas" style="display: none;"></canvas>
            <div class="button-block">
                <button id="capture-photo" data-i18n="capture_photo">Сделать фото</button>
            </div>
        </div>
    </div>

    <script>
        window.quantumSketch = new p5(function(sketch) {
            console.log('p5 setup called');
            sketch.setup = function() {
                var canvas = sketch.createCanvas(800, 800, p5.WEBGL);
                canvas.class('quantum-canvas');
                canvas.parent('portrait-animation-container-step-4');
                sketch.pixelDensity(2);
                sketch.noLoop();
            };

            sketch.draw = function() {
                sketch.background(26, 26, 26); // Соответствует новому фону
                if (window.currentStep === 4 || window.currentStep === 5) {
                    if (window.particles && window.particles.length > 0) {
                        window.updateParticles(sketch);
                    }
                    if (window.img) {
                        sketch.image(window.img, 0, 0, sketch.width, sketch.height);
                    }
                }
            };

            sketch.mouseMoved = function() {
                if (window.currentStep === 4 || window.currentStep === 5) {
                    window.observeParticles(sketch, sketch.mouseX, sketch.mouseY);
                }
            };

            sketch.mouseClicked = function() {
                if (window.currentStep === 4 || window.currentStep === 5) {
                    window.clickParticles(sketch, sketch.mouseX, sketch.mouseY);
                    sketch.loop();
                }
            };

            sketch.startAnimation = function() {
                sketch.loop();
            };

            sketch.switchCanvasParent = function(stepIndex) {
                let containerId = stepIndex === 4 ? 'portrait-animation-container-step-4' : 'portrait-animation-container-step-5';
                let container = document.getElementById(containerId);
                if (container && sketch.canvas) {
                    container.appendChild(sketch.canvas);
                }
            };
        });

        document.getElementById('uploadImage').addEventListener('click', function() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                if (e.target.files.length > 0) {
                    var file = e.target.files[0];
                    window.quantumSketch.loadImage(URL.createObjectURL(file), function(img) {
                        if (img.width < 800 || img.height < 800) {
                            img.resize(800, 800);
                        }
                        window.img = img;
                        window.initializeParticles(img);
                        document.querySelectorAll('#thumbnail-portrait').forEach(thumbnail => {
                            thumbnail.src = URL.createObjectURL(file);
                            thumbnail.style.display = 'block';
                        });
                        window.moveToNextStep(2.1);
                    });
                }
            };
            input.click();
        });

        document.getElementById('saveImage').addEventListener('click', function() {
            const portraitName = document.getElementById('portraitName').value || 'quantum_portrait';
            window.quantumSketch.saveCanvas(portraitName, 'png');
            window.terminalMessages.push(`[SAVE] Quantum portrait saved as ${portraitName}.png`);
            window.updateTerminalLog();
        });

        document.getElementById('shareObservation').addEventListener('click', function() {
            window.open('https://t.me/quantum_portrait_channel', '_blank');
        });

        document.getElementById('restart').addEventListener('click', function() {
            window.location.reload();
        });

        document.getElementById('archive').addEventListener('click', function() {
            window.open('https://t.me/quantum_portrait_channel', '_blank');
        });

        document.getElementById('aboutAuthors').addEventListener('click', function() {
            window.location.href = './about.html';
        });

        var originalMoveToNextStep = window.moveToNextStep;
        window.moveToNextStep = function(stepIndex) {
            originalMoveToNextStep(stepIndex);
            document.querySelectorAll('#thumbnail-portrait').forEach(thumbnail => {
                thumbnail.style.display = (stepIndex === 4 || stepIndex === 5) ? 'block' : 'none';
            });
            if (stepIndex === 4 || stepIndex === 5) {
                window.quantumSketch.switchCanvasParent(stepIndex);
                window.quantumSketch.startAnimation();
                window.terminalMessages = [];
                window.terminalMessages.push(`[INIT] Quantum portrait animation started for step ${stepIndex}`);
                window.updateTerminalLog();
            } else {
                window.quantumSketch.noLoop();
                window.terminalMessages = [];
                window.updateTerminalLog();
            }
            const totalSteps = 7;
            const progress = (stepIndex / totalSteps) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        };
    </script>
</body>
</html>

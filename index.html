<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Квантовые портреты</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
</head>
<body>
    <section id="step-0" class="step step-centered">
        <div class="text-block typewriter" data-i18n="step0_text">Пожалуйста, выберите язык RU / ENG</div>
        <div class="button-block">
            <button class="language-btn" data-lang="ru" onclick="window.setLanguageAndNext('ru')">RU</button>
            <button class="language-btn" data-lang="eng" onclick="window.setLanguageAndNext('eng')">ENG</button>
        </div>
    </section>

    <section id="step-1" class="step step-centered">
        <div class="step-title" data-i18n="step1_title">СТАТУС: НАБЛЮДАТЕЛЬ ПОДКЛЮЧЁН</div>
        <div class="text-block typewriter" data-i18n="step1_text1">> Чему Шредингер может научить нас в области цифровой идентификации?</div>
        <div class="text-block typewriter" data-i18n="step1_text2">> Добро пожаловать в экспериментальную зону.</div>
        <div class="text-block typewriter" data-i18n="step1_text3">> Здесь наблюдение = вмешательство.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
    </section>

    <section id="step-2" class="step step-centered">
        <div class="step-title" data-i18n="step2_title">Шаг 1: Сканируйте лицо суперпозиции.</div>
        <div class="text-block typewriter" data-i18n="step2_text1">Вы можете загрузить изображение или выбрать вариант из архива.</div>
        <div class="button-block">
            <button id="uploadImage">Загрузить изображение</button>
            <button id="openGallery">Выбрать из архива</button>
            <button id="activateCamera">Активировать камеру</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>

    <section id="step-2.1" class="step step-centered">
        <div class="text-block typewriter" data-i18n="step2_text2">> Изображение принято.</div>
        <div class="text-block typewriter" data-i18n="step2_text3">> Запускается волновая функция.</div>
        <div class="text-block typewriter" data-i18n="step2_text4">> Система готова к инициализации.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>

    <section id="step-3" class="step step-centered">
        <div class="step-title" data-i18n="step3_title">Шаг 2: Инициализация</div>
        <div class="text-block typewriter" data-i18n="step3_text1">> Изображение преобразовано в пиксельную сетку.</div>
        <div class="text-block typewriter" data-i18n="step3_text2">> Каждому пикселю назначены параметры (x, y, brightness, color)</div>
        <div class="text-block typewriter" data-i18n="step3_text3">> На их основе построена волновая функция: ψ(x, y, t)</div>
        <div class="text-block typewriter" data-i18n="step3_text4">Уравнение эволюции:</div>
        <div class="text-block typewriter" data-i18n="step3_text5">iℏ ∂ψ/∂t = Ĥψ, где Ĥ = -½∇² + V(x, y)</div>
        <div class="text-block typewriter" data-i18n="step3_text6">> Потенциал V(x, y) формируется из визуальных характеристик изображения.</div>
        <div class="text-block typewriter" data-i18n="step3_text7">> Система переходит в режим временной симуляции.</div>
        <div class="text-block typewriter" data-i18n="step3_text8">> Портрет существует как совокупность возможных состояний.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>

    <section id="step-4" class="step step-centered">
        <div class="step-title" data-i18n="step4_title">Шаг 3: НАЧНИТЕ НАБЛЮДЕНИЕ</div>
        <div class="text-block typewriter" data-i18n="step4_text1">Двигайте курсором по изображению.</div>
        <div class="text-block typewriter" data-i18n="step4_text2">Каждый ваш жест запускает коллапс.</div>
        <div class="text-block typewriter" data-i18n="step4_text3">Система реагирует. Наблюдаемый образ формируется здесь и сейчас.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>

    <section id="step-5" class="step step-centered">
        <div class="step-title" data-i18n="step5_title">Шаг 4: ФИКСАЦИЯ</div>
        <div class="text-block typewriter" data-i18n="step5_text1">> Портрет — это процесс.</div>
        <div class="text-block typewriter" data-i18n="step5_text2">> Но ты можешь зафиксировать один миг.</div>
        <div class="text-block typewriter" data-i18n="step5_text3">> Это будет один из возможных тебя.</div>
        <div class="button-block">
            <button id="recordButton">Записать</button>
            <div id="saveInput" style="display: none;">
                <input type="text" id="portraitName" placeholder="Имя портрета">
                <button id="saveButton">Сохранить</button>
            </div>
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>

    <section id="step-6" class="step step-centered">
        <div class="step-title" data-i18n="step6_title">Шаг 5: РЕАКЦИЯ СИСТЕМЫ</div>
        <div class="text-block typewriter" data-i18n="step6_text1">Это не портрет.</div>
        <div class="text-block typewriter" data-i18n="step6_text2">Это — реакция системы на тебя.</div>
        <div class="text-block typewriter" data-i18n="step6_text3">Ты повлиял на исход.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>

    <section id="step-7" class="step step-centered">
        <div class="step-title" data-i18n="step7_title">Заключение</div>
        <div class="text-block typewriter" data-i18n="step7_text1">Ты — не единственный наблюдатель</div>
        <div class="text-block typewriter" data-i18n="step7_text2">Каждое наблюдение — это акт, формирующий образ.</div>
        <div class="text-block typewriter" data-i18n="step7_text3">Здесь ты — одновременно субъект и объект.</div>
        <div class="button-block">
            <button onclick="window.restart()">Начать заново</button>
            <button onclick="window.shareToArchive()">Поделиться в архив</button>
            <button onclick="window.aboutAuthors()">Об авторах</button>
        </div>
        <div id="portrait-animation-container"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>

    <script>
        let quantumSketch = null;
        window.img = null;
        window.currentStep = 0;
        window.currentQuantumState = 'init';
        window.frame = 0;
        window.isPaused = false;
        window.particles = [];
        window.quantumStates = [];
        window.isCanvasReady = false;
        window.noiseScale = 0.05;
        window.mouseInfluenceRadius = 200;
        window.chaosFactor = 0.5;
        window.boundaryPoints = [];
        window.trailBuffer = null;

        window.loadImageOnce = () => {
            if (window.img) return;
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (!window.quantumSketch) initializeQuantumSketch();
                    window.quantumSketch.loadImage(URL.createObjectURL(file), (img) => {
                        window.img = img;
                        if (window.currentStep === 2) {
                            window.showStep(2.1);
                            if (typeof initializeParticles === 'function') initializeParticles(img);
                        }
                    });
                }
            };
            input.click();
        };

        window.activateCamera = () => alert('Функция активации камеры пока не реализована.');
        window.openGallery = () => alert('Функция выбора из архива пока не реализована.');
        window.restart = () => {
            window.img = null;
            window.currentQuantumState = 'init';
            window.particles = [];
            window.quantumStates = [];
            window.frame = 0;
            window.isPaused = false;
            if (window.quantumSketch) {
                window.quantumSketch.noLoop();
                window.quantumSketch.remove();
                window.quantumSketch = null;
            }
            window.showStep(0);
        };
        window.shareToArchive = () => alert('Функция поделиться в архив пока не реализована.');
        window.aboutAuthors = () => alert('Информация об авторах пока не реализована.');

        function initializeQuantumSketch() {
            if (window.quantumSketch) return;
            const container = document.getElementById('portrait-animation-container');
            if (!container) {
                console.error('Container portrait-animation-container not found');
                return;
            }
            window.quantumSketch = new p5((sketch) => {
                window.sketch = sketch;
                sketch.setup = () => {
                    console.log('p5 setup called');
                    let canvas = sketch.createCanvas(400, 400);
                    canvas.parent('portrait-animation-container');
                    console.log('Canvas created, width: 400, height: 400');
                    sketch.pixelDensity(1);
                    window.trailBuffer = sketch.createGraphics(400, 400);
                    window.isCanvasReady = true;
                    if (window.img && typeof initializeParticles === 'function') initializeParticles(window.img);
                    sketch.loop();
                };
                sketch.draw = () => {
                    console.log('draw called, currentStep:', window.currentStep, 'canvasVisible:', document.querySelector('#portrait-animation-container canvas')?.style.display !== 'none');
                    sketch.background(255);
                    sketch.fill(255, 0, 0);
                    sketch.rect(100, 100, 200, 200);
                    sketch.fill(0);
                    sketch.textSize(16);
                    sketch.text(`Frame: ${window.frame}`, 10, 20);
                    if (window.currentStep < 2 || !window.img) {
                        sketch.text('Пожалуйста, загрузите изображение', 10, 40);
                        window.frame++;
                        return;
                    }
                    window.frame++;
                    let scale = Math.min(sketch.width / window.img.width, sketch.height / window.img.height);
                    let displayWidth = window.img.width * scale;
                    let displayHeight = window.img.height * scale;
                    let x = (sketch.width - displayWidth) / 2;
                    let y = (sketch.height - displayHeight) / 2;
                    sketch.image(window.img, x, y, displayWidth, displayHeight);
                    console.log('Image rendered at x:', x, 'y:', y, 'width:', displayWidth, 'height:', displayHeight);
                    if (window.currentStep >= 3 && window.isCanvasReady && window.particles.length > 0 && typeof updateParticles === 'function') {
                        updateParticles();
                        window.particles.forEach((p, i) => {
                            p.x = Math.max(0, Math.min(400, p.x));
                            p.y = Math.max(0, Math.min(400, p.y));
                            p.offsetX = Math.max(-p.x, Math.min(400 - p.x, p.offsetX));
                            p.offsetY = Math.max(-p.y, Math.min(400 - p.y, p.offsetY));
                            let state = window.quantumStates[i] || { r: 255, g: 0, b: 0, a: 255 };
                            sketch.fill(state.r, state.g, state.b, state.a);
                            sketch.ellipse(p.x + p.offsetX, p.y + p.offsetY, p.size || 10);
                        });
                    }
                };
                sketch.startAnimation = () => {
                    window.currentQuantumState = 'superposition';
                    sketch.loop();
                };
            }, 'portrait-animation-container');
        }

        window.showStep = (stepIndex) => {
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => {
                const stepId = parseFloat(step.id.replace('step-', '')) || stepIndex;
                if (stepId === stepIndex) {
                    step.classList.add('active');
                    step.style.display = 'flex';
                } else {
                    step.classList.remove('active');
                    step.style.display = 'none';
                }
            });
            window.currentStep = stepIndex;
            console.log('Current step:', stepIndex);
            if (stepIndex >= 2 && !window.quantumSketch) initializeQuantumSketch();
            if (stepIndex === 2.1 && window.quantumSketch) window.quantumSketch.startAnimation();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const uploadButton = document.getElementById('uploadImage');
            if (uploadButton) uploadButton.addEventListener('click', window.loadImageOnce);
            const galleryButton = document.getElementById('openGallery');
            if (galleryButton) galleryButton.addEventListener('click', window.openGallery);
            const cameraButton = document.getElementById('activateCamera');
            if (cameraButton) cameraButton.addEventListener('click', window.activateCamera);
            document.querySelectorAll('.continue').forEach(button => {
                button.removeEventListener('click', window.handleContinue); // Удаляем старые обработчики
                button.addEventListener('click', window.handleContinue = (e) => {
                    const stepElement = e.target.closest('.step');
                    const current = parseFloat(stepElement.id.replace('step-', '')) || window.currentStep;
                    let nextStep = current + (current === 2 ? 0.1 : 1);
                    if (nextStep <= 7) window.showStep(nextStep);
                });
            });
        });
    </script>
    <script src="js/utils.js"></script>
    <script src="js/observer.js"></script>
    <script src="js/textSteps.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/globals.js"></script>
    <script src="js/main.js"></script>
    <script src="js/particles.js"></script>
</body>
</html>

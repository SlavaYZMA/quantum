<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Portrait</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="globals.js"></script>
    <script src="particles.js"></script>
    <script src="observer.js"></script>
    <script src="main.js"></script>
</head>
<body>
    <section id="step-0" class="step">
        <div class="text-block typewriter" data-i18n="step0_text">Пожалуйста, выберите язык RU / ENG</div>
        <div class="button-block">
            <button onclick="window.setLanguageAndNext('ru')">RU</button>
            <button onclick="window.setLanguageAndNext('en')">ENG</button>
        </div>
    </section>
    <section id="step-1" class="step step-centered">
        <div class="step-title" data-i18n="step1_title">СТАТУС: НАБЛЮДАТЕЛЬ ПОДКЛЮЧЁН</div>
        <div class="text-block typewriter" data-i18n="step1_text1">> Чему Шредингер может научить нас в области цифровой идентификации?</div>
        <div class="text-block typewriter" data-i18n="step1_text2">> Добро пожаловать в экспериментальную зону.</div>
        <div class="text-block typewriter" data-i18n="step1_text3">> Здесь наблюдение = вмешательство</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
    </section>
    <section id="step-2" class="step step-centered">
        <div class="step-title" data-i18n="step2_title">Шаг 1: Сканируйте лицо суперпозиции.</div>
        <div class="text-block typewriter" data-i18n="step2_text1">Вы можете загрузить изображение или выбрать вариант из архива.</div>
        <div class="button-block">
            <button id="uploadImage">Загрузить изображение</button>
            <button id="openGallery">Выбрать из архива</button>
            <button id="activateCamera">Активировать камеру</button>
        </div>
        <div id="portrait-animation-container-step-2" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>
    <section id="step-2.1" class="step step-centered">
        <div class="text-block typewriter" data-i18n="step2_text2">> Изображение принято.</div>
        <div class="text-block typewriter" data-i18n="step2_text3">> Запускается волновая функция.</div>
        <div class="text-block typewriter" data-i18n="step2_text4">> Система готова к инициализации.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container-step-2.1" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>
    <section id="step-3" class="step step-centered">
        <div class="step-title" data-i18n="step3_title">Шаг 2: Инициализация</div>
        <div class="text-block typewriter" data-i18n="step3_text1">> Изображение преобразовано в пиксельную сетку.</div>
        <div class="text-block typewriter" data-i18n="step3_text2">> Каждому пикселю назначены параметры (x, y, brightness, color).</div>
        <div class="text-block typewriter" data-i18n="step3_text3">> На их основе построена волновая функция: ψ(x, y, t)</div>
        <div class="text-block typewriter" data-i18n="step3_text4">Уравнение эволюции:</div>
        <div class="text-block typewriter" data-i18n="step3_text5">iℏ ∂ψ/∂t = Ĥψ, где Ĥ = -½∇² + V(x, y)</div>
        <div class="text-block typewriter" data-i18n="step3_text6">> Потенциал V(x, y) формируется из визуальных характеристик изображения.</div>
        <div class="text-block typewriter" data-i18n="step3_text7">> Система переходит в режим временной симуляции.</div>
        <div class="text-block typewriter" data-i18n="step3_text8">> Портрет существует как совокупность возможных состояний.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container-step-3" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>
    <section id="step-4" class="step step-centered">
        <div class="step-title" data-i18n="step4_title">Шаг 3: НАЧНИТЕ НАБЛЮДЕНИЕ</div>
        <div class="text-block typewriter" data-i18n="step4_text1">Двигайте курсором по изображению.</div>
        <div class="text-block typewriter" data-i18n="step4_text2">Каждый ваш жест запускает коллапс.</div>
        <div class="text-block typewriter" data-i18n="step4_text3">Система реагирует. Наблюдаемый образ формируется здесь и сейчас.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container-step-4" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>
    <section id="step-5" class="step step-centered">
        <div class="step-title" data-i18n="step5_title">Шаг 4: ФИКСАЦИЯ</div>
        <div class="text-block typewriter" data-i18n="step5_text1">> Портрет — это процесс.</div>
        <div class="text-block typewriter" data-i18n="step5_text2">> Но ты можешь зафиксировать один миг.</div>
        <div class="text-block typewriter" data-i18n="step5_text3">> Это будет один из возможных тебя.</div>
        <div class="button-block">
            <button id="recordButton">Записать</button>
            <div id="saveInput" style="display: none;">
                <input id="portraitName" type="text" placeholder="Введите имя портрета">
                <button id="saveButton">Сохранить</button>
            </div>
        </div>
        <div id="portrait-animation-container-step-5" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>
    <section id="step-6" class="step step-centered">
        <div class="step-title" data-i18n="step6_title">Шаг 5: РЕАКЦИЯ СИСТЕМЫ</div>
        <div class="text-block typewriter" data-i18n="step6_text1">Это не портрет.</div>
        <div class="text-block typewriter" data-i18n="step6_text2">Это — реакция системы на тебя.</div>
        <div class="text-block typewriter" data-i18n="step6_text3">Ты повлиял на исход.</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container-step-6" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>
    <section id="step-7" class="step step-centered">
        <div class="step-title" data-i18n="step7_title">Заключение</div>
        <div class="text-block typewriter" data-i18n="step7_text1">Ты — не единственный наблюдатель</div>
        <div class="text-block typewriter" data-i18n="step7_text2">Каждое наблюдение — это акт, формирующий образ.</div>
        <div class="text-block typewriter" data-i18n="step7_text3">Здесь ты — одновременно субъект и объект.</div>
        <div class="button-block">
            <button class="continue">Завершить</button>
        </div>
        <div id="portrait-animation-container-step-7" style="border: 2px dashed #0f0;"></div>
        <img id="saved-portrait" style="display: none; max-width: 400px; margin: 20px auto;">
    </section>

    <script>
        let sketch = (sketch) => {
            sketch.setup = () => {
                console.error('p5 setup called');
                let canvas = sketch.createCanvas(400, 400);
                canvas.class('quantum-canvas');
                console.error('Canvas created, width: 400, height: 400');
                sketch.pixelDensity(1);
                window.trailBuffer = sketch.createGraphics(400, 400);
                window.isCanvasReady = true;
                sketch.noLoop();
                // Перемещение canvas будет в main.js
            };

            sketch.draw = () => {
                console.error('draw called, currentStep: ' + window.currentStep + ', canvasVisible: ' + (document.querySelector('.quantum-canvas').style.display !== 'none'));
                if (window.currentStep < 3) {
                    sketch.background(255);
                    sketch.fill(255, 0, 0);
                    sketch.rect(100, 100, 200, 200);
                    if (window.img && window.isCanvasReady) {
                        let imgWidth = 400;
                        let imgHeight = 400;
                        if (window.img.width > window.img.height) {
                            imgHeight = 400 * window.img.height / window.img.width;
                        } else {
                            imgWidth = 400 * window.img.width / window.img.height;
                        }
                        let x = (400 - imgWidth) / 2;
                        let y = (400 - imgHeight) / 2;
                        sketch.image(window.img, x, y, imgWidth, imgHeight);
                        console.error('Image rendered at x: ' + x + ', y: ' + y + ', width: ' + imgWidth + ', height: ' + imgHeight);
                    }
                    sketch.textAlign(sketch.LEFT, sketch.TOP);
                    sketch.textSize(20);
                    sketch.fill(0);
                    sketch.text('Frame: ' + sketch.frameCount, 10, 10);
                } else {
                    sketch.background(255);
                    sketch.fill(255, 0, 0);
                    sketch.rect(100, 100, 200, 200);
                    if (window.img && window.isCanvasReady) {
                        sketch.image(window.img, 0, 0, 400, 400);
                        console.error('Image rendered at x: 0, y: 0, width: 400, height: 400');
                    }
                    if (window.particles && window.particles.length > 0) {
                        window.updateParticles(sketch);
                    }
                    sketch.textAlign(sketch.LEFT, sketch.TOP);
                    sketch.textSize(20);
                    sketch.fill(0);
                    sketch.text('Frame: ' + sketch.frameCount, 10, 10);
                }
            };

            sketch.startAnimation = () => {
                console.error('startAnimation called, currentStep: ' + window.currentStep);
                sketch.loop();
            };

            sketch.mouseMoved = () => {
                if (window.currentStep === 4 && window.particles && window.particles.length > 0) {
                    window.observeParticles(sketch.mouseX, sketch.mouseY);
                }
            };
        };

        window.quantumSketch = new p5(sketch);
        document.getElementById('uploadImage').addEventListener('click', () => {
            let input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                if (e.target.files[0] && window.quantumSketch) {
                    window.quantumSketch.loadImage(URL.createObjectURL(e.target.files[0]), (img) => {
                        window.img = img;
                        window.moveToNextStep(2);
                    }, () => {
                        console.error('Error loading image');
                    });
                } else {
                    console.error('quantumSketch not initialized before loading image');
                }
            };
            input.click();
        });
    </script>
</body>
</html>

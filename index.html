<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Квантовые портреты</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <section id="step-0" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text" data-i18n="step0_text">Пожалуйста, выберите язык RU / ENG</p>
            </div>
        </div>
        <div class="text-block">
            <div class="button-block">
                <button class="language-btn" onclick="setLanguageAndNext('ru')">RU</button>
                <button class="language-btn" onclick="setLanguageAndNext('eng')">ENG</button>
            </div>
        </div>
    </section>

    <section id="step-1" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text step-title" data-i18n="step1_title">СТАТУС: НАБЛЮДАТЕЛЬ ПОДКЛЮЧЁН</p>
            </div>
            <div class="text-block typewriter" data-i18n="step1_text1">> Чему Шредингер может научить нас в области цифровой идентификации?</div>
            <div class="text-block typewriter" data-i18n="step1_text2">> Добро пожаловать в экспериментальную зону.</div>
            <div class="text-block typewriter" data-i18n="step1_text3">> Здесь наблюдение = вмешательство</div>
        </div>
        <div class="text-block">
            <div class="button-block">
                <button class="back">Назад</button>
                <button class="continue">Продолжить</button>
            </div>
        </div>
    </section>

    <section id="step-2" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text step-title" data-i18n="step2_title">Шаг 1: Сканируйте лицо суперпозиции.</p>
            </div>
            <div class="text-block">
                <p class="language-text" data-i18n="step2_text1">Вы можете загрузить изображение или выбрать вариант из архива.</p>
            </div>
        </div>
        <div class="text-block">
            <div class="button-block">
                <button class="action-btn" id="loadImageButton" onclick="loadImageOnce()">Загрузить портрет</button>
                <button class="action-btn" onclick="openGallery()">Выбрать из архива</button>
            </div>
            <div class="button-block">
                <button class="back">Назад</button>
                <button class="continue" onclick="continueStep2()">Продолжить</button>
            </div>
        </div>
    </section>

    <section id="step-2-1" class="step">
        <div class="step-centered">
            <div class="text-block typewriter" data-i18n="step2_text2">> Изображение принято.</div>
        </div>
        <div class="text-block">
            <div class="text-block typewriter" data-i18n="step2_text3">> Запускается волновая функция.</div>
            <div class="text-block typewriter" data-i18n="step2_text4">> Система готова к инициализации.</div>
            <div class="button-block">
                <button class="back">Назад</button>
                <button class="continue">Продолжить</button>
            </div>
        </div>
    </section>

    <section id="step-3" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text step-title" data-i18n="step3_title">Шаг 2: Инициализация</p>
            </div>
        </div>
        <div class="text-block">
            <div class="text-block typewriter" data-i18n="step3_text1">> Изображение преобразовано в пиксельную сетку.</div>
            <div class="text-block typewriter" data-i18n="step3_text2">> Каждому пикселю назначены параметры (x, y, brightness, color)<span class="green-text"> (x, y, brightness, color)</span>.</div>
            <div class="text-block typewriter" data-i18n="step3_text3">> На их основе построена волновая функция: ψ(x, y, t)<span class="green-text"> ψ(x, y, t)</span>.</div>
            <div class="text-block typewriter" data-i18n="step3_text4">Уравнение эволюции:</div>
            <div class="text-block typewriter">
                <p class="language-text green-text" data-i18n="step3_text5">iℏ ∂ψ/∂t = Ĥψ, где Ĥ = -½∇² + V(x, y)</p>
            </div>
            <div class="text-block typewriter" data-i18n="step3_text6">> Потенциал V(x, y)<span class="green-text"> V(x, y)</span> формируется из визуальных характеристик изображения.</div>
            <div class="text-block typewriter" data-i18n="step3_text7">> Система переходит в режим временной симуляции.</div>
            <div class="text-block typewriter" data-i18n="step3_text8">> Портрет существует как совокупность возможных состояний.</div>
            <div class="button-block">
                <button class="back">Назад</button>
                <button class="continue">Продолжить</button>
            </div>
        </div>
    </section>

    <section id="step-4" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text step-title" data-i18n="step4_title">Шаг 3: НАЧНИТЕ НАБЛЮДЕНИЕ</p>
            </div>
        </div>
        <div class="text-block typewriter" data-i18n="step4_text1">Двигайте курсором по изображению.</div>
        <div class="text-block typewriter" data-i18n="step4_text2">Каждый ваш жест запускает коллапс.</div>
        <div class="text-block typewriter" data-i18n="step4_text3">Система реагирует. Наблюдаемый образ формируется здесь и сейчас.</div>
        <div class="split-container">
            <div id="quantum-visualization-container" class="quantum-visualization-container" style="width: 100%; height: 300px;"></div>
            <div class="terminal-container">
                <p id="terminal-message">Терминал: Инициализация...</p>
            </div>
        </div>
        <div class="portrait-animation-container" id="portrait-animation-container" style="width: 100%; margin: 20px 0;"></div>
        <div class="button-block">
            <button class="back">Назад</button>
            <button class="continue">Продолжить</button>
        </div>
    </section>

    <section id="step-5" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text step-title" data-i18n="step5_title">Шаг 4: ФИКСАЦИЯ</p>
            </div>
        </div>
        <div class="text-block typewriter" data-i18n="step5_text1">> Портрет — это процесс.</div>
        <div class="text-block typewriter" data-i18n="step5_text2">> Но ты можешь зафиксировать один миг.</div>
        <div class="text-block typewriter" data-i18n="step5_text3">> Это будет один из возможных тебя.</div>
        <div class="split-container">
            <div id="quantum-visualization-container" class="quantum-visualization-container" style="width: 100%; height: 300px;"></div>
            <div class="terminal-container">
                <p id="terminal-message">Терминал: Квантовая анимация обновляется...</p>
            </div>
        </div>
        <div class="portrait-animation-container" id="portrait-animation-container" style="width: 100%; margin: 20px 0;"></div>
        <div class="button-block">
            <button class="action-btn" id="recordButton">ЗАПИСАТЬ НАБЛЮДЕНИЕ</button>
            <button class="back">Назад</button>
            <button class="continue">Продолжить</button>
        </div>
        <div id="saveInput" style="display: none; margin-top: 20px;">
            <input type="text" id="portraitName" placeholder="Как назовёшь?" style="padding: 5px;">
            <button id="saveButton" style="margin-left: 10px;">Сохранить</button>
        </div>
    </section>

    <section id="step-6" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text step-title" data-i18n="step6_title">Шаг 5: РЕАКЦИЯ СИСТЕМЫ</p>
            </div>
        </div>
        <div class="text-block">
            <div class="text-block typewriter" data-i18n="step6_text1">Это не портрет.</div>
            <div class="text-block typewriter" data-i18n="step6_text2">Это — реакция системы на тебя.</div>
            <div class="text-block typewriter" data-i18n="step6_text3">Ты повлиял на исход.</div>
            <div class="image-container">
                <img id="saved-portrait" src="" alt="Saved Portrait" style="display: none;">
            </div>
            <div class="text-block">
                <input type="text" id="portrait-name" placeholder="Введите название портрета">
            </div>
            <div class="button-block">
                <button class="back">Назад</button>
                <button class="continue">Продолжить</button>
            </div>
        </div>
    </section>

    <section id="step-7" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text step-title" data-i18n="step7_title">Заключение</p>
            </div>
        </div>
        <div class="text-block">
            <div class="text-block typewriter" data-i18n="step7_text1">Ты — не единственный наблюдатель</div>
            <div class="text-block typewriter" data-i18n="step7_text2">Каждое наблюдение — это акт, формирующий образ.</div>
            <div class="text-block typewriter" data-i18n="step7_text3">Здесь ты — одновременно субъект и объект.</div>
            <div class="button-block">
                <button class="action-btn" onclick="shareToArchive()">Поделиться изображением в архив</button>
                <button class="back">Назад</button>
            </div>
        </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script>
        if (typeof p5 !== 'undefined') {
            console.log('p5.js loaded successfully at', new Date().toLocaleTimeString());
            // Инициализация для portrait-animation-container
            window.quantumSketch = new p5((sketch) => {
                window.sketch = sketch;
                let isPaused = false;
                sketch.setup = () => {
                    sketch.createCanvas(400, 400).parent('portrait-animation-container');
                    sketch.noLoop();
                };
                sketch.draw = () => {
                    sketch.background(0);
                    if (window.img) {
                        sketch.image(window.img, 0, 0, sketch.width, sketch.height);
                    } else {
                        console.log('No image available for drawing');
                    }
                    if (!isPaused) {
                        if (window.currentQuantumState === 'superposition') {
                            for (let i = 0; i < 100; i++) {
                                let x = sketch.random(sketch.width);
                                let y = sketch.random(sketch.height);
                                let prob = sketch.noise(x * 0.01, y * 0.01);
                                if (prob > 0.3) {
                                    sketch.stroke(0, 255 * prob, 100);
                                    sketch.point(x, y);
                                }
                            }
                        } else if (window.currentQuantumState === 'collapse') {
                            let centerX = sketch.width / 2;
                            let centerY = sketch.height / 2;
                            for (let i = 0; i < 100; i++) {
                                let angle = sketch.random(TWO_PI);
                                let r = sketch.map(sketch.sin(sketch.frameCount * 0.01 + i), -1, 1, 0, 150);
                                let x = centerX + r * sketch.cos(angle);
                                let y = centerY + r * sketch.sin(angle);
                                sketch.stroke(255, 50, 0, 255 - r * 1.5);
                                sketch.point(x, y);
                            }
                        }
                    }
                };
                sketch.mousePressed = () => {
                    if (window.currentStep === 5 && sketch.contains(sketch.mouseX, sketch.mouseY)) {
                        isPaused = !isPaused;
                        if (isPaused) {
                            console.log('Animation paused at step 5');
                            document.getElementById('recordButton').style.display = 'none';
                            document.getElementById('saveInput').style.display = 'block';
                        } else {
                            console.log('Animation resumed at step 5');
                            document.getElementById('recordButton').style.display = 'inline-block';
                            document.getElementById('saveInput').style.display = 'none';
                        }
                    }
                };
                window.loadImageOnce = () => {
                    if (window.img) {
                        console.warn('Image already loaded, skipping new load');
                        return;
                    }
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            console.log('Loading image:', file.name);
                            sketch.loadImage(URL.createObjectURL(file), (img) => {
                                window.img = img;
                                console.log('Image loaded successfully, size:', img.width, 'x', img.height);
                            }, (err) => {
                                console.error('Error loading image:', err);
                            });
                        }
                    };
                    input.click();
                };
                sketch.startAnimation = () => {
                    if (!window.img) {
                        console.warn('No image available for animation. Please upload an image on Step 2.');
                        return;
                    }
                    console.log('Starting animation');
                    sketch.loop();
                };
            }, 'portrait-animation-container');

            // Инициализация для quantum-visualization-container
            window.quantumVisualization = new p5((sketch) => {
                window.visualSketch = sketch;
                sketch.setup = () => {
                    sketch.createCanvas(window.innerWidth, window.innerHeight).parent('quantum-visualization-container');
                    sketch.windowResized = () => {
                        sketch.resizeCanvas(window.innerWidth, window.innerHeight);
                    };
                };
                sketch.draw = () => {
                    sketch.background(20);
                    let state = window.currentQuantumState || 'init';
                    switch (state) {
                        case 'superposition':
                            for (let i = 0; i < 200; i++) {
                                let x = sketch.random(sketch.width);
                                let y = sketch.random(sketch.height);
                                let fade = sketch.sin(sketch.frameCount * 0.03 + i) * 255;
                                sketch.stroke(0, 255, 150, fade);
                                sketch.strokeWeight(3);
                                sketch.point(x, y);
                            }
                            break;
                        case 'collapse':
                            let centerX = sketch.width / 2;
                            let centerY = sketch.height / 2;
                            let r = sketch.map(sketch.sin(sketch.frameCount * 0.03), -1, 1, 0, sketch.height / 3);
                            sketch.noStroke();
                            sketch.fill(255, 100, 0, 255 - r * 1.5);
                            sketch.ellipse(centerX, centerY, r * 2, r * 2);
                            sketch.fill(255, 200, 0, 100);
                            sketch.ellipse(centerX, centerY, r, r);
                            break;
                    }
                };
            }, 'quantum-visualization-container');
        } else {
            console.error('p5.js failed to load - please check your internet connection or URL');
        }

        window.continueStep2 = () => {
            console.log('Checking image status:', window.img ? 'Image available' : 'No image available');
            if (window.img) {
                if (typeof showStep === 'function') showStep(2.1);
            } else {
                alert('Пожалуйста, загрузите изображение перед продолжением!');
            }
        };

        window.showStep = (step) => {
            console.log('Showing step:', step, 'Current steps length:', document.querySelectorAll('.step').length);
            document.querySelectorAll('.step').forEach(s => s.style.display = 'none');
            const targetStep = document.getElementById(`step-${step}`);
            if (targetStep) {
                targetStep.style.display = 'block';
                console.log(`Step ${step} displayed successfully`);
            } else {
                console.error(`Step ${step} not found, defaulting to step 0`);
                document.getElementById('step-0').style.display = 'block';
            }
            window.currentStep = step;
            console.log('Updated currentStep to:', window.currentStep);
            if (step === 4 || step === 5) {
                if (window.quantumSketch) {
                    window.quantumSketch.startAnimation();
                    startDynamicUpdates();
                    console.log('Dynamic updates started for step', step);
                }
            } else {
                stopDynamicUpdates();
                console.log('Dynamic updates stopped for step', step);
            }
        };
        window.openGallery = () => console.log('Gallery opened');
        window.shareToArchive = () => console.log('Image shared to archive');

        // Добавим счетчик фиксаций
        window.fixationCount = 0;
        console.log('Initial step setup, all continue buttons:', document.querySelectorAll('.continue'));

        document.querySelectorAll('.continue').forEach(btn => {
            btn.addEventListener('click', (e) => {
                console.log('Continue button event triggered, target:', e.target, 'Parent step:', e.target.closest('.step')?.id);
                if (window.currentStep !== undefined) {
                    console.log('Continue button clicked on step:', window.currentStep, 'Button:', e.target, 'Expected next step:', window.currentStep === 5 ? 4 : window.currentStep + 1);
                    if (window.currentStep === 2.1) {
                        showStep(3);
                    } else if (window.currentStep === 5) {
                        showStep(4); // Возвращаемся к наблюдению
                        window.fixationCount++; // Увеличиваем счетчик
                        console.log('Fixation count increased to:', window.fixationCount);
                        if (window.fixationCount >= 1) { // Переход на 6 после одной фиксации
                            showStep(6);
                            window.fixationCount = 0; // Сброс счетчика
                        }
                    } else if (window.currentStep !== 2) {
                        showStep(window.currentStep + 1);
                    }
                } else {
                    console.warn('window.currentStep is undefined, cannot proceed');
                }
            });
        });
        document.querySelectorAll('.back').forEach(btn => {
            btn.addEventListener('click', () => {
                if (window.currentStep !== undefined && window.currentStep > 0) {
                    console.log('Back button clicked on step:', window.currentStep, 'Going to:', window.currentStep === 2.1 ? 2 : window.currentStep - 1);
                    if (window.currentStep === 2.1) showStep(2);
                    else showStep(window.currentStep - 1);
                }
            });
        });
        showStep(0);

        const terminalMessages = [
            'Терминал: Инициализация...',
            'Суперпозиция: Частица в множественных состояниях, зеленые точки показывают вероятности.',
            'Коллапс: Измерение фиксирует состояние, оранжевый круг сжимается.'
        ];
        let messageIndex = 0;
        const quantumStates = ['init', 'superposition', 'collapse'];
        window.currentQuantumState = 'init';

        function startDynamicUpdates() {
            console.log('Starting dynamic updates at', new Date().toLocaleTimeString());
            if (window.updateInterval) clearInterval(window.updateInterval);
            window.updateInterval = setInterval(() => {
                if (window.currentStep === 4 || window.currentStep === 5) {
                    const terminal = document.getElementById('terminal-message');
                    if (terminal) {
                        console.log('Updating terminal to:', terminalMessages[messageIndex], 'at', new Date().toLocaleTimeString());
                        terminal.textContent = terminalMessages[messageIndex];
                        window.currentQuantumState = quantumStates[messageIndex];
                        messageIndex = (messageIndex + 1) % terminalMessages.length;
                    }
                }
            }, 5000);
        }

        function stopDynamicUpdates() {
            console.log('Stopping dynamic updates at', new Date().toLocaleTimeString());
            if (window.updateInterval) {
                clearInterval(window.updateInterval);
                window.updateInterval = null;
            }
        }

        document.getElementById('recordButton').addEventListener('click', () => {
            if (window.quantumSketch) {
                window.quantumSketch.startAnimation();
                console.log('Record button clicked, preparing to pause');
                document.getElementById('recordButton').style.display = 'none';
                document.getElementById('saveInput').style.display = 'block';
            }
        });

        document.getElementById('saveButton').addEventListener('click', () => {
            const name = document.getElementById('portraitName').value;
            if (name && window.quantumSketch) {
                const dataURL = window.quantumSketch.get().canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `${name}.png`;
                link.href = dataURL;
                link.click();
                console.log(`Portrait saved as: ${name}.png, resuming step 5`);
                document.getElementById('saveInput').style.display = 'none';
                document.getElementById('recordButton').style.display = 'inline-block';
            } else {
                alert('Пожалуйста, введите имя портрета!');
            }
        });
    </script>
    <script src="js/globals.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/particles.js"></script>
    <script src="js/observer.js"></script>
    <script src="js/textSteps.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/main.js"></script>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Квантовые портреты</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
</head>
<body>
    <section id="step-0" class="step step-centered">
        <div class="text-block typewriter" data-i18n="step0_text">Пожалуйста, выберите язык RU / ENG</div>
        <div class="button-block">
            <button class="language-btn" data-lang="ru" onclick="setLanguageAndNext('ru')">RU</button>
            <button class="language-btn" data-lang="eng" onclick="setLanguageAndNext('eng')">ENG</button>
        </div>
    </section>

    <section id="step-1" class="step step-centered">
        <div class="step-title" data-i18n="step1_title">СТАТУС: НАБЛЮДАТЕЛЬ ПОДКЛЮЧЁН</div>
        <div class="text-block typewriter" data-i18n="step1_text1">> Чему Шредингер может научить нас?</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
    </section>

    <section id="step-2" class="step step-centered">
        <div class="step-title" data-i18n="step2_title">Шаг 1: Анимация начинается</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
    </section>

    <section id="step-3" class="step step-centered">
        <div class="step-title" data-i18n="step3_title">Шаг 2: Движение частиц</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
    </section>

    <section id="step-4" class="step step-centered">
        <div class="step-title" data-i18n="step4_title">Шаг 3: Интерактивность</div>
        <div class="text-block typewriter" data-i18n="step4_text1">Двигай курсор!</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
    </section>

    <section id="step-5" class="step step-centered">
        <div class="step-title" data-i18n="step5_title">Шаг 4: Фиксация</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
    </section>

    <section id="step-6" class="step step-centered">
        <div class="step-title" data-i18n="step6_title">Шаг 5: Реакция</div>
        <div class="button-block">
            <button class="continue">Продолжить</button>
        </div>
        <div id="portrait-animation-container" style="border: 2px dashed #0f0;"></div>
    </section>

    <section id="step-7" class="step step-centered">
        <div class="step-title" data-i18n="step7_title">Заключение</div>
        <div class="button-block">
            <button onclick="restart()">Начать заново</button>
        </div>
        <div id="portrait-animation-container"></div>
    </section>

    <script src="js/particles.js"></script>
    <script>
        let quantumSketch = null;
        window.frame = 0;
        window.isPaused = false;
        window.particles = [];
        window.quantumStates = [];
        window.isCanvasReady = false;
        window.noiseScale = 0.05;
        window.mouseInfluenceRadius = 200;
        window.chaosFactor = 0.5;
        window.boundaryPoints = [];
        window.trailBuffer = null;

        function initializeQuantumSketch() {
            if (quantumSketch) {
                console.log('quantumSketch already initialized');
                return;
            }
            quantumSketch = new p5((sketch) => {
                window.sketch = sketch;
                sketch.setup = () => {
                    console.log('p5 setup called');
                    let canvas = sketch.createCanvas(400, 400);
                    canvas.parent('portrait-animation-container');
                    sketch.pixelDensity(1);
                    window.trailBuffer = sketch.createGraphics(400, 400);
                    window.trailBuffer.pixelDensity(1);
                    window.isCanvasReady = true;
                    initializeParticles(); // Вызов после создания canvas
                    sketch.loop();
                };
                sketch.draw = () => {
                    console.log('draw called, frame:', window.frame, 'particles:', window.particles.length);
                    sketch.background(0);
                    window.frame++;
                    if (window.isCanvasReady && window.particles.length > 0) {
                        updateParticles();
                    }
                };
                sketch.startAnimation = () => {
                    console.log('Starting animation');
                    sketch.loop();
                };
            }, 'portrait-animation-container');
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing event listeners');
            initializeQuantumSketch();
            document.querySelectorAll('.continue').forEach(button => {
                button.addEventListener('click', (e) => {
                    const stepElement = e.target.closest('.step');
                    const current = parseFloat(stepElement.id.replace('step-', '')) || 0;
                    let nextStep = current + 1;
                    if (nextStep <= 7) {
                        showStep(nextStep);
                        if (nextStep >= 2 && quantumSketch) {
                            initializeParticles();
                            quantumSketch.startAnimation();
                        }
                    }
                });
            });
        });

        function showStep(stepIndex) {
            document.querySelectorAll('.step').forEach(step => {
                const stepId = parseFloat(step.id.replace('step-', ''));
                if (stepId === stepIndex) {
                    step.classList.add('active');
                    step.style.display = 'flex';
                } else {
                    step.classList.remove('active');
                    step.style.display = 'none';
                }
            });
        }

        function setLanguageAndNext(lang) {
            console.log(`Language set to: ${lang}, moving to step 1`);
            showStep(1);
        }

        function restart() {
            console.log('Restarting application');
            window.particles = [];
            window.quantumStates = [];
            window.frame = 0;
            window.isPaused = false;
            if (quantumSketch) {
                quantumSketch.noLoop();
                quantumSketch.remove();
                quantumSketch = null;
            }
            initializeQuantumSketch();
            showStep(0);
        }
    </script>

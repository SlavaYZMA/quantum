<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Portrait</title>
    <link rel="icon" href="data:;base64,=">
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="./js/globals.js"></script>
    <script src="./js/particles.js"></script>
    <script src="./js/observer.js"></script>
    <script src="./js/main.js"></script>
    <script src="./js/audio.js"></script>
    <script src="./js/textSteps.js"></script>
    <script src="./js/utils.js"></script>
    <script src="./js/text-flicker.js"></script>
</head>
<body>
    <section id="step-0" class="step quantum-flux">
        <div class="text-cluster">Выберите язык: RU или ENG</div>
        <div class="quantum-cluster">
            <div class="particle-button" data-action="setLanguageAndNext('ru')">RU</div>
            <div class="particle-button" data-action="setLanguageAndNext('en')">ENG</div>
        </div>
    </section>
    <section id="step-1" class="step quantum-flux">
        <div class="text-cluster">
            <div>Добро пожаловать на шаг 1</div>
            <div>Исследуйте квантовый мир</div>
            <div>Выберите следующий шаг</div>
        </div>
        <div class="quantum-cluster">
            <div class="particle-button continue">Продолжить</div>
            <div class="particle-button back">Назад</div>
        </div>
    </section>
    <section id="step-2" class="step quantum-flux">
        <div class="text-cluster">
            <div>Шаг 2: Выбор изображения</div>
            <div>Загрузите или используйте камеру</div>
        </div>
        <div class="quantum-cluster">
            <div class="particle-button" id="uploadImage">Загрузить</div>
            <div class="particle-button" id="useCamera">Камера</div>
            <div class="particle-button" id="useArchive">Архив</div>
            <div class="particle-button back">Назад</div>
        </div>
    </section>
    <section id="step-2.1" class="step quantum-flux">
        <div class="text-cluster">
            <div>Шаг 2.1: Обработка изображения</div>
            <div>Готово к анализу</div>
            <div>Перейдите дальше</div>
        </div>
        <div class="quantum-cluster">
            <div class="particle-button continue">Продолжить</div>
            <div class="particle-button back">Назад</div>
        </div>
    </section>
    <section id="step-3" class="step quantum-flux">
        <div class="text-cluster">
            <div>Шаг 3: Настройка параметров</div>
            <div>Настройте уровень шума</div>
            <div>Выберите хаос</div>
            <div>Продолжайте эксперимент</div>
        </div>
        <div class="quantum-cluster">
            <div class="particle-button continue">Продолжить</div>
            <div class="particle-button back">Назад</div>
        </div>
    </section>
    <section id="step-4" class="step quantum-flux">
        <div class="text-cluster">
            <div>Шаг 4: Анимация</div>
            <div>Смотрите квантовую эволюцию</div>
        </div>
        <div class="quantum-observation">
            <div id="portrait-animation-container-step-4"></div>
            <div class="terminal-log" id="terminal-log-step-4"></div>
        </div>
        <div class="quantum-cluster">
            <div class="particle-button continue">Продолжить</div>
            <div class="particle-button back">Назад</div>
        </div>
    </section>
    <section id="step-5" class="step quantum-flux">
        <div class="text-cluster">
            <div>Шаг 5: Сохранение</div>
            <div>Назови своё творение</div>
        </div>
        <div class="quantum-observation">
            <div id="portrait-animation-container-step-5"></div>
            <div class="terminal-log" id="terminal-log-step-5"></div>
        </div>
        <div class="quantum-cluster">
            <input class="quantum-input" id="portraitName" type="text" placeholder="Назови ∅">
            <div class="particle-button" id="saveImage">Записать</div>
            <div class="particle-button continue">Продолжить</div>
            <div class="particle-button back">Назад</div>
        </div>
    </section>
    <section id="step-6" class="step quantum-flux">
        <div class="text-cluster">
            <div>Шаг 6: Поделиться</div>
            <div>Расскажи миру</div>
        </div>
        <div class="quantum-cluster">
            <div class="particle-button" id="shareObservation">Поделиться</div>
            <div class="particle-button continue">Продолжить</div>
            <div class="particle-button back">Назад</div>
        </div>
    </section>
    <section id="step-7" class="step quantum-flux">
        <div class="text-cluster">
            <div>Шаг 7: Завершение</div>
            <div>Спасибо за путешествие</div>
        </div>
        <div class="quantum-cluster">
            <div class="particle-button" id="restart">↻ Снова</div>
            <div class="particle-button" id="archive">⧉ Архив</div>
            <div class="particle-button" id="aboutAuthors">О нас</div>
            <div class="particle-button back">Назад</div>
        </div>
    </section>
    <div id="image-archive-modal" class="modal quantum-flux">
        <div class="modal-cluster">
            <div class="close-particle" id="close-modal">×</div>
            <div class="image-grid" id="image-grid"></div>
        </div>
    </div>
    <div id="camera-modal" class="modal quantum-flux">
        <div class="modal-cluster">
            <div class="close-particle" id="close-camera-modal">×</div>
            <video id="camera-video" autoplay style="width: 100%; max-width: 640px; height: auto;"></video>
            <canvas id="camera-canvas" style="display: none;"></canvas>
            <div class="quantum-cluster">
                <div class="particle-button" id="capture-photo">Сфоткать</div>
            </div>
        </div>
    </div>

    <script>
        window.quantumSketch = new p5(function(sketch) {
            sketch.setup = function() {
                var canvas = sketch.createCanvas(400, 400);
                if (canvas) {
                    canvas.class('quantum-canvas');
                    canvas.parent('portrait-animation-container-step-4');
                    console.log('Canvas initialized:', canvas.width, canvas.height);
                    sketch.noLoop();
                } else {
                    console.error('Canvas creation failed, retrying...');
                    setTimeout(() => sketch.setup(), 100);
                }
            };

            sketch.draw = function() {
                sketch.background(0);
                if (window.currentStep === 4 || window.currentStep === 5) {
                    if (window.particles) window.updateParticles(sketch);
                    sketch.fill(255);
                    sketch.textSize(16);
                    sketch.text('Frame: ' + (window.frame || 0), 10, 20);
                }
            };

            sketch.mouseMoved = function() { if (window.currentStep === 4 || window.currentStep === 5) window.observeParticles(sketch, sketch.mouseX, sketch.mouseY); };
            sketch.mouseClicked = function() { if (window.currentStep === 4 || window.currentStep === 5) { window.clickParticles(sketch, sketch.mouseX, sketch.mouseY); sketch.loop(); } };

            sketch.startAnimation = function() { sketch.loop(); };
            sketch.switchCanvasParent = function(stepIndex) {
                let containerId = stepIndex === 4 ? 'portrait-animation-container-step-4' : 'portrait-animation-container-step-5';
                let container = document.getElementById(containerId);
                if (container && sketch.canvas) container.appendChild(sketch.canvas);
                else console.error('Canvas or container not found for switch');
            };
        });

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, applying initial styles');
            document.querySelectorAll('.particle-button').forEach(button => {
                window.assembleText(button);
                button.addEventListener('mouseover', () => window.assembleText(button));
                button.addEventListener('mouseout', () => window.disassembleText(button));
                button.addEventListener('click', (e) => {
                    const action = button.getAttribute('data-action') || button.id;
                    console.log('Button clicked:', action);
                    if (action && window[action]) window[action]();
                    else console.error(`Function ${action} not found in window`);
                });
            });

            window.uploadImage = function() {
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    if (e.target.files[0] && window.quantumSketch) {
                        var file = e.target.files[0];
                        window.quantumSketch.loadImage(URL.createObjectURL(file), function(img) {
                            window.img = img;
                            window.initializeParticles(img);
                            document.querySelectorAll('#thumbnail-portrait').forEach(thumbnail => { thumbnail.src = URL.createObjectURL(file); thumbnail.style.display = (window.currentStep === 4 || window.currentStep === 5) ? 'block' : 'none'; });
                            window.moveToNextStep(2.1);
                            input.remove();
                        }, () => { input.remove(); });
                    }
                };
                input.click();
            };

            window.saveImage = function() {
                const portraitName = document.getElementById('portraitName')?.value || 'quantum_portrait';
                window.quantumSketch.saveCanvas(portraitName, 'png');
                window.terminalMessages.push(`[SAVE] ${portraitName}.png`);
                window.updateTerminalLog();
            };

            window.shareObservation = function() { window.open('https://t.me/quantum_portrait_channel', '_blank'); };
            window.restart = function() { window.location.reload(); };
            window.archive = function() { window.open('https://t.me/quantum_portrait_channel', '_blank'); };
            window.aboutAuthors = function() { window.location.href = './about.html'; };
            window.capturePhoto = function() {
                const video = document.getElementById('camera-video');
                const canvas = document.getElementById('camera-canvas');
                const modal = document.getElementById('camera-modal');
                if (!video || !canvas || !modal) {
                    console.error('Video, canvas, or modal not found');
                    return;
                }

                canvas.width = 400;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');

                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;
                let sx, sy, sWidth, sHeight;

                const videoAspect = videoWidth / videoHeight;
                const canvasAspect = 1;
                if (videoAspect > canvasAspect) {
                    sWidth = videoHeight * canvasAspect;
                    sHeight = videoHeight;
                    sx = (videoWidth - sWidth) / 2;
                    sy = 0;
                } else {
                    sWidth = videoWidth;
                    sHeight = videoWidth / canvasAspect;
                    sx = 0;
                    sy = (videoHeight - sHeight) / 2;
                }

                ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);
                console.log('Photo captured, dimensions: ' + canvas.width + ', ' + canvas.height);

                const imageUrl = canvas.toDataURL('image/png');

                window.quantumSketch.loadImage(imageUrl, function(img) {
                    console.log('Captured image loaded successfully, dimensions: ' + img.width + ', ' + img.height);
                    window.img = img;
                    window.initializeParticles(img);
                    var thumbnails = document.querySelectorAll('#thumbnail-portrait');
                    thumbnails.forEach(function(thumbnail) {
                        thumbnail.src = imageUrl;
                        thumbnail.style.display = (window.currentStep === 4 || window.currentStep === 5) ? 'block' : 'none';
                        console.log('Updated thumbnail src: ' + thumbnail.src + ', display: ' + thumbnail.style.display);
                    });
                    window.moveToNextStep(2.1);
                    stopCamera();
                    modal.style.display = 'none';
                }, function(err) {
                    console.error('Error loading captured image:', err);
                    alert('Ошибка обработки фото. Пожалуйста, попробуйте снова.');
                });
            };

            window.startCamera = function() {
                const modal = document.getElementById('camera-modal');
                const video = document.getElementById('camera-video');
                if (!modal || !video) {
                    console.error('Camera modal or video element not found');
                    return;
                }

                navigator.mediaDevices.getUserMedia({ video: true })
                    .then((stream) => {
                        console.log('Camera access granted');
                        cameraStream = stream;
                        video.srcObject = stream;
                        modal.style.display = 'flex';
                    })
                    .catch((err) => {
                        console.error('Error accessing camera:', err);
                        alert('Не удалось получить доступ к камере. Пожалуйста, разрешите доступ или используйте другое устройство.');
                    });
            };
        });
    </script>

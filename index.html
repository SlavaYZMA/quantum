<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Квантовые портреты</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Секции остаются без изменений -->
    <section id="step-0" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text" data-i18n="step0_text">Пожалуйста, выберите язык RU / ENG</p>
            </div>
        </div>
        <div class="scrollable-content">
            <div class="button-block">
                <button class="language-btn" onclick="setLanguageAndNext('ru')">RU</button>
                <button class="language-btn" onclick="setLanguageAndNext('eng')">ENG</button>
            </div>
        </div>
    </section>

    <!-- ... (остальные секции без изменений) ... -->

    <section id="step-4" class="step">
        <div class="step-centered">
            <div class="text-block">
                <p class="language-text step-title" data-i18n="step4_title">Шаг 3: НАЧНИТЕ НАБЛЮДЕНИЕ</p>
            </div>
        </div>
        <div class="scrollable-content">
            <div class="text-block typewriter" data-i18n="step4_text1">Двигайте курсором по изображению.</div>
            <div class="text-block typewriter" data-i18n="step4_text2">Каждый ваш жест запускает коллапс.</div>
            <div class="text-block typewriter" data-i18n="step4_text3">Система реагирует. Наблюдаемый образ формируется здесь и сейчас.</div>
            <div class="split-container">
                <div class="animation-container">
                    <p>Контейнер для визуализации квантовых процессов (зарезервировано)</p>
                </div>
                <div class="terminal-container">
                    <p>Терминал: Квантовая анимация обновляется...</p>
                </div>
            </div>
            <div class="portrait-animation-container" id="portrait-animation-container"></div>
            <div class="button-block">
                <button class="back">Назад</button>
                <button class="continue">Продолжить</button>
            </div>
        </div>
    </section>

    <!-- ... (остальные секции без изменений) ... -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script>
        if (typeof p5 !== 'undefined') {
            console.log('p5.js loaded successfully at', new Date().toLocaleTimeString());
            window.quantumSketch = new p5((sketch) => {
                window.sketch = sketch;
                sketch.setup = () => {
                    sketch.createCanvas(400, 400).parent('portrait-animation-container');
                    sketch.noLoop();
                };
                sketch.loadImage = () => {
                    console.log('loadImage function called');
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        console.log('File input changed, processing file...');
                        const file = e.target.files[0];
                        if (file) {
                            sketch.loadImage(URL.createObjectURL(file), (img) => {
                                console.log('Image loaded successfully:', img.width, 'x', img.height);
                                window.img = img;
                                if (typeof showStep === 'function' && window.currentStep === 2) {
                                    showStep(3);
                                }
                            }, (err) => {
                                console.error('Error loading image:', err);
                            });
                        } else {
                            console.log('No file selected');
                        }
                    };
                    try {
                        input.click();
                        console.log('File input triggered');
                    } catch (error) {
                        console.error('Failed to trigger file input:', error);
                    }
                };
                sketch.recordObservation = () => {
                    if (window.img && !sketch.isLooping()) {
                        console.log('Observation recorded');
                        let dataURL = sketch.get().canvas.toDataURL();
                        document.getElementById('saved-portrait').src = dataURL;
                        document.getElementById('saved-portrait').style.display = 'block';
                        if (typeof showStep === 'function') showStep(6);
                    }
                };
                sketch.startAnimation = () => {
                    if (window.img) {
                        console.log('Starting animation');
                        sketch.image(window.img, 0, 0, sketch.width, sketch.height);
                        sketch.loop();
                    } else {
                        console.error('No image available for animation');
                    }
                };
            }, 'portrait-animation-container');
        } else {
            console.error('p5.js failed to load - please check your internet connection or URL');
        }
    </script>
    <script src="js/globals.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/particles.js"></script>
    <script src="js/observer.js"></script>
    <script src="js/textSteps.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/main.js"></script>
    <script>
        console.log('All scripts loaded, checking functions:', {
            setLanguageAndNext: typeof setLanguageAndNext === 'function',
            loadImage: typeof window.quantumSketch?.loadImage === 'function',
            startAnimation: typeof window.quantumSketch?.startAnimation === 'function',
            recordObservation: typeof window.quantumSketch?.recordObservation === 'function',
            shareToArchive: typeof shareToArchive === 'function'
        });
    </script>
